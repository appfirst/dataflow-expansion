function main(){d3.select(this).on("keydown",function(){if(d3.event.ctrlKey&&!buttonDown){ctrlPressed=true;buttonDown=true}}).on("keyup",function(){if(d3.event.keyCode==17){ctrlPressed=false;buttonDown=false}});queue().defer(getFile,"http://localhost:9000/api/v1/metrics/?name=sys.server.*.*").awaitAll(function(e,t){if(typeof e==null){console.log(e);return}createHeatMap(t)})}function filterServers(){function n(e,t){if(e.toLowerCase()<t.toLowerCase()){return-1}else if(e.toLowerCase()==t.toLowerCase()){return 0}else{return 1}}function r(e,t){if(Number(servers[e].cpu)<Number(servers[t].cpu)){return-1}else if(Number(servers[e].cpu)==Number(servers[t].cpu)){return 0}else{return 1}}function i(e,t){if(Number(servers[e].pnum)<Number(servers[t].pnum)){return-1}else if(Number(servers[e].pnum)==Number(servers[t].pnum)){return 0}else{return 1}}function s(e,t){if(Number(servers[e].sread)<Number(servers[t].sread)){return-1}else if(Number(servers[e].sread)==Number(servers[t].sread)){return 0}else{return 1}}function o(e,t){if(Number(servers[e].swrite)<Number(servers[t].swrite)){return-1}else if(Number(servers[e].swrite)==Number(servers[t].swrite)){return 0}else{return 1}}function u(e,t){if(Number(servers[e].page_faults)<Number(servers[t].page_faults)){return-1}else if(Number(servers[e].page_faults)==Number(servers[t].page_faults)){return 0}else{return 1}}var e=d3.select("#tiles").selectAll("g");if(combobox.selection.selectedIndex==0){var t=e.sort(n)}else if(combobox.selection.selectedIndex==1){var t=e.sort(r)}else if(combobox.selection.selectedIndex==2){var t=e.sort(i)}else if(combobox.selection.selectedIndex==3){var t=e.sort(s)}else if(combobox.selection.selectedIndex==4){var t=e.sort(o)}else if(combobox.selection.selectedIndex==5){var t=e.sort(u)}t[0].forEach(function(e,t){d3.select(e).transition().duration(1e3).attr("transform",function(n){var r=-d3.select(e).select("rect").attr("x")+t%15*40;var i=-d3.select(e).select("rect").attr("y")+40*Math.floor(t/15);return"translate("+r+","+i+")"})})}function filterSockets(){var e=$(".socket_threshold_filter").slider("option","value");d3.select("#socket").selectAll("line").filter(function(){if(socombobox[1].soselection.selectedIndex==0){return d3.select(this)[0][0].__data__["Data Sent (bytes)"]<=e||!isNaN(e)&&e>0}else if(socombobox[1].soselection.selectedIndex==1){return d3.select(this)[0][0].__data__["Data Received (bytes)"]<=e||!isNaN(e)&&e>0}else if(socombobox[1].soselection.selecrtedIndex==2){return d3.select(this)[0][0].__data__["Time Open (sec)"]<=e||!isNaN(e)&&e>0}}).transition().duration(500).attr("opacity",0).attr("display","none");d3.select("#socket").selectAll("line").filter(function(){if(socombobox[1].soselection.selectedIndex==0){return d3.select(this)[0][0].__data__["Data Sent (bytes)"]>e||!isNaN(e)&&e==0}else if(socombobox[1].soselection.selectedIndex==1){return d3.select(this)[0][0].__data__["Data Received (bytes)"]>e||!isNaN(e)&&e==0}else if(socombobox[1].soselection.selecrtedIndex==2){return d3.select(this)[0][0].__data__["Time Open (sec)"]<=e||!isNaN(e)&&e>0}}).transition().duration(500).attr("opacity",1).attr("display","inline")}function changeThreshold(){transition=true;if(tcombobox.selection.selectedIndex===0){$(".threshold_slider").slider("option","max",100);$(".threshold_slider").slider("option","value",100)}else if(tcombobox.selection.selectedIndex===1){$(".threshold_slider").slider("option","max",500);$(".threshold_slider").slider("option","value",500)}else if(tcombobox.selection.selectedIndex===2||tcombobox.selection.selectedIndex===3){$(".threshold_slider").slider("option","max",1048576);$(".threshold_slider").slider("option","value",1048576)}d3.select("#tiles").selectAll("g").select("text").transition().duration(500).style("opacity",0).each("end",function(e){d3.select(this).text(function(e){function t(e){if(e===null||e.toString().indexOf("null")!=-1){return"?"}else{return e}}if(tcombobox.selection.selectedIndex===0){return t(servers[e].cpu)}else if(tcombobox.selection.selectedIndex===1){return t(servers[e].pnum)}else if(tcombobox.selection.selectedIndex===2){return t(viewDataSize(servers[e].swrite))}else if(tcombobox.selection.selectedIndex===3){return t(viewDataSize(servers[e].sread))}}).transition().duration(500).style("opacity",1)});transition=false}function changeProcThreshold(){transition=true;if(ptcombobox.selection.selectedIndex===0){$(".proc_threshold_slider").slider("option","max",100);$(".proc_threshold_slider").slider("option","value",100);$(".proc_threshold_slider").slider("option","step",1);$(".proc_threshold_filter").slider("option","max",100);$(".proc_threshold_filter").slider("option","step",1);d3.select("#procs").selectAll("g").select("text").transition().duration(500).style("opacity",0).each("end",function(e){d3.select(this).text(function(e){return e.data[0].cpu}).transition().duration(500).style("opacity",1)})}else if(ptcombobox.selection.selectedIndex===1){$(".proc_threshold_slider").slider("option","max",1048576);$(".proc_threshold_slider").slider("option","value",1048576);$(".proc_threshold_slider").slider("option","step",100);$(".proc_threshold_filter").slider("option","max",1048576);$(".proc_threshold_filter").slider("option","step",100);d3.select("#procs").selectAll("g").select("text").transition().duration(500).style("opacity",0).each("end",function(e){d3.select(this).text(function(e){return viewDataSize(e.data[0].sread)}).transition().duration(500).style("opacity",1)})}transition=false}function changeSocketThreshold(){if(socombobox[1].soselection.selectedIndex==0||socombobox[1].soselection.selectedIndex==1){$(".socket_threshold_filter").slider("option","max",1048576);$(".socket_threshold_filter").slider("option","value",0);$(".socket_threshold_filter").slider("option","step",100)}else if(socombobox[1].soselection.selectedIndex==2){$(".socket_threshold_filter").slider("option","max",100);$(".socket_threshold_filter").slider("option","value",0);$(".socket_threshold_filter").slider("option","step",1)}}function viewDataSize(e){if(typeof e!="undefined"){if(e<=1024)e+=" B";else if(e<1048576){e=Math.floor(e/1024*10)/10+" KB"}else if(e<=1073741824){e=Math.floor(e/1048576*10)/10+" MB"}return e}else{return"0 B"}}function nullCheck(e){if(e==null){return"Unknown"}else{return e}}function mOverSocket(e){var t=d3.select("#socket-details");t.select("#socket-status").text("Status: "+e.__data__.Status);t.select("#socket-port").text("Port: "+e.__data__["Socket Port"]);t.select("#socket-type").text("Type: "+e.__data__.Type);t.select("#socket-sent").text("Data Sent: "+viewDataSize(e.__data__["Data Sent (bytes)"]));t.select("#socket-received").text("Data Received: "+viewDataSize(e.__data__["Data Received (bytes)"]));t.select("#socket-linked").text("Linked to: "+serverLinkMap[e.__data__["Peer IP"]]);t.select("#socket-time").text("Time Open: "+e.__data__["Time Open (sec)"]+" s");d3.select("#socket").selectAll("line").transition().duration(300).style("stroke-width",2).style("stroke","black");d3.select(e).transition().duration(300).style("stroke","blue").style("stroke-width",6)}function mOutSocket(){var e=d3.select("#socket-details");e.select("#socket-status").text("Status: ");e.select("#socket-port").text("Port: ");e.select("#socket-type").text("Type: ");e.select("#socket-sent").text("Data Sent: ");e.select("#socket-received").text("Data Received: ")}function mOverServer(e,t){$(".tooltip").html("Name: "+e+"<br>CPU Usage: "+nullCheck(servers[e].cpu)+"%"+"<br>Inbound Traffic: "+viewDataSize(Number(servers[e].sread))+"<br>Outbound Traffic: "+viewDataSize(Number(servers[e].swrite))+"<br>No. of Processes: "+servers[e].pnum+"<br>Page Faults: "+nullCheck(servers[e].pfault));d3.select(".tooltip").transition().duration(200).style("opacity",.9);t.select("rect").transition().duration(200).style("stroke-width",2).style("stroke","black").style("opacity",.7)}function mOutServer(e){d3.select(".tooltip").transition().duration(200).style("opacity",0);if(e.select(".hoverable").attr("selected")==null){e.select("rect").transition().duration(200).style("stroke-width",1).style("stroke","gray").style("opacity",1)}}function mOverProcess(e,t){t.select("rect").transition().duration(200).style("stroke-width",2).style("stroke","black").style("opacity",.7);$(".tooltip").html("Name: "+e.name+"<br>CPU Usage: "+e.data[0].cpu+"%"+"<br>Inbound Traffic: "+viewDataSize(Number(e.data[0].sread))+"<br>Outbound Traffic: "+viewDataSize(Number(e.data[0].swrite)));d3.select(".tooltip").transition().duration(200).style("opacity",.9)}function mOutProcess(e){d3.select(".tooltip").transition().duration(200).style("opacity",0);if(e.select(".hoverable").attr("selected")==null){e.select("rect").transition().duration(200).style("stroke-width",1).style("stroke","gray").style("opacity",1)}}function zoomIn(e,t){if(layer==1){layer=2;if(e[0][0].length==1){$(".threshold_slider").slider("option","disabled",true);d3.selectAll(".hoverable").on("mouseout",null).on("mouseover",null).on("click",null).on("mousemove",null);d3.select(".tooltip").transition().duration(300).style("opacity",1e-16);d3.select("#scombobox").select("form").select("select").attr("disabled",true);d3.select(".tcombobox").select("form").select("select").attr("disabled",true);var n=function(t){d3.select("body").select("#mainDiv").select("svg").select("g").selectAll("rect")[0].forEach(function(n,r){if(n.__data__==e[0][0][0].__data__){thisRect=n;oldx=thisRect.x.baseVal.value;oldy=thisRect.y.baseVal.value;if(t!=undefined){t()}}})};var r=function(t){$("#tiles").fadeOut();d3.select("body").select("#mainDiv").select("svg").append("g").attr("class","backbutton").append("rect").attr("width",0).attr("height",0).attr("opacity",0).style("fill","white").classed("back",true).attr("x",20).attr("y",20).attr("width",50).attr("height",30).transition().duration(1e3).attr("opacity",1);d3.select(".backbutton").append("text").text("Back").attr("width",0).attr("height",0).attr("font-size",0).attr("font-size",12).attr("x",32).attr("y",40).attr("opacity",0).transition().duration(1e3).attr("opacity",1);d3.select(e[0][0][0]).moveToFront};queue().defer(n).awaitAll(function(){$("#bellsnwhistles").fadeOut(500,function(){$("#processbells").fadeIn(500)});r()})}else{multiServer=true;$("#tiles").fadeOut();d3.select("body").select("#mainDiv").select("svg").append("g").attr("class","backbutton").append("rect").style("opacity",0).style("fill","white").classed("back",true).attr("width",50).attr("height",30).attr("x",20).attr("y",20).transition().duration(1e3).style("opacity",1);d3.select(".backbutton").append("text").text("Back").attr("font-size",12).attr("x",32).attr("y",40).style("opacity",0).transition().duration(1e3).style("opacity",1);$("#bellsnwhistles").fadeOut(500,function(){$("#processbells").fadeIn(500)})}}else if(layer==2){layer=3;d3.select("#mainsvg").append("g").attr("id","socket");$(e).clone().appendTo("#socket");$(e).hide();d3.select("#socket").select("g").select("text").remove();d3.select("#socket").select("rect").attr("class",null).style("stroke","black").style("stroke-width",2).transition().duration(1e3).attr("transform",function(t){var n=d3.select(e).attr("transform");if(n!=null){var r=n.substring(n.indexOf("(")+1,n.length-1).split(",");var i=280-Number(r[0])-Number(d3.select(e).select("rect").attr("x"));var s=280-Number(r[1])-Number(d3.select(e).select("rect").attr("y"))}else{var i=280-d3.select(e).select("rect").attr("x");var s=280-d3.select(e).select("rect").attr("y")}return"translate("+i+","+s+")"});$("#procs").children().fadeOut();showLines(d3.select(e)[0][0].__data__.id);d3.select(".backbutton").on("mousedown",null);$("#processbells").fadeOut(500,function(){d3.select(".backbutton").on("mousedown",function(){zoomOut()});$("#socketbells").fadeIn(500)})}}function click(e,t){if(ctrlPressed&&(!d3.select(t).attr("selected")||!d3.select(t).select("rect").attr("selected"))){d3.select(t).select("rect").attr("selected",true).style("stroke-width","2px").style("stroke","black").style("opacity",.7);$("#selected-servers").html($("#selected-servers").html()+t.__data__+"<br>")}else if(ctrlPressed&&d3.select(t).select("rect").attr("selected")){d3.select(t).select("rect").attr("selected",null).style("stroke-width","1px").style("stroke","gray").style("opacity",1);$("#selected-servers").html($("#selected-servers").html().replace(t.__data__+"<br>",""))}else{d3.select(t).select("rect").attr("selected",true);$("#selected-servers").html($("#selected-servers").html()+t.__data__+"<br>");var n=[];d3.select("#tiles").selectAll("g").select("rect").filter(function(e){return d3.select(this).attr("selected")}).call(function(t){t[0].forEach(function(e,t){d3.select(e).style("stroke-width","1px").style("stroke","gray").style("opacity",1).attr("selected",null);n.push(e.__data__)});zoomIn(d3.select(t[0]),e)});processes(n);d3.select("#selected-servers").text("");d3.select(t).attr("selected",null)}}function zoomOut(){if(layer==2){layer=1;if(!multiServer){d3.select("#textBox")[0][0].value="";d3.select("#tiles").selectAll("g").on("mouseover",function(e){mOverServer(e,d3.select(this))}).on("mouseout",function(){mOutServer(d3.select(this))}).on("mousemove",function(){moveToolTip()});d3.select("#scombobox").select("form").select("select").attr("disabled",null);d3.select(".tcombobox").select("form").select("select").attr("disabled",null);d3.select("#textBox").attr("disabled",true);$(".threshold_slider").slider("option","disabled",false);$("#procs").fadeOut(function(){$("#procs").remove();$("#tiles").fadeIn(function(){d3.select("#tiles").selectAll("g").on("click",function(e,t){click(t,this)})})})}else{$("#procs").fadeOut(function(){$("#procs").remove();$("#tiles").fadeIn()});multiServer=false}$(".backbutton").fadeOut(500);$("#processbells").fadeOut(500,function(){$(".backbutton").remove();$("#bellsnwhistles").fadeIn(500)})}else if(layer==3){layer=2;$("#socket *").fadeOut(1e3,$("#socket").remove());$("#socket").remove();$("#procs g:hidden").fadeIn(1e3);d3.select(".backbutton").on("mousedown",null);d3.select("#procs").selectAll("g").on("click",null);$("#socketbells").fadeOut(500,function(){$("#processbells").fadeIn(500);d3.select("#procs").selectAll("g").on("click",function(e,t){zoomIn(this,t)});d3.select(".backbutton").on("mousedown",function(){zoomOut()})})}}function createHeatMap(data){function parseServerData(){eval(data[0]["collectors"]).forEach(function(e){collectorIDs[e[0]]=e[1]});var collectors={};for(var c in data[0]["request"]["collectors"]){collectors[data[0]["request"]["collectors"][c]]={}}Object.keys(data[0]["data"]).forEach(function(e){var t=e.replace("sys.server.","");var n=t;var r="";while(n!==""&&n.indexOf(".")!=-1&&Object.keys(collectors).indexOf(r)==-1){if(r!==""){r=r+"."}var i=n.indexOf(".")+1;var s=n.substring(0,i);r=r+s;r=r.substring(0,r.length-1);n=n.replace(s,"")}collectors[r][n]=data[0]["data"][e][0]["value"]});return collectors}servers=parseServerData();createTiles();createTools()}function createTiles(){var e=Object.keys(servers);var t,n,r;d3.select("body").select("#mainDiv").append("div").attr("id","appcontainer").append("svg").attr("id","mainsvg").attr("width",600).attr("height",600);d3.select("body").select("#mainDiv").select("svg").append("g").attr("id","tiles").selectAll("g").data(e).enter().append("g").on("mouseover",function(e){mOverServer(e,d3.select(this))}).on("mousemove",function(e){moveToolTip()}).on("mouseout",function(){mOutServer(d3.select(this))}).on("click",function(e,t){click(t,this)}).append("rect").attr("x",function(e,t){return 40*(t%columns)}).attr("y",function(e,t){return Math.floor(t/columns)*40}).attr("width",40).attr("height",40);d3.select("#tiles").selectAll("g").append("text").attr("x",function(e,t){return 20+40*(t%15)}).attr("y",function(e,t){return 20+40*Math.floor(t/15)}).classed("quick-num",true).text(function(e){return servers[e].cpu!=null?servers[e].cpu:"?"});createToolTip()}function createToolTip(){var e=d3.select("#mainDiv").append("div").classed("tooltip",true).style("opacity",0)}function moveToolTip(){d3.select(".tooltip").style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY+10+"px")}function createTools(){$("#mainDiv").prepend(jQuery("<div/>",{id:"bellsnwhistles","class":"bellsnwhistles",display:"none"}));$("#mainDiv").prepend(jQuery("<div/>",{id:"processbells","class":"bellsnwhistles",display:"none"}));$("#mainDiv").prepend(jQuery("<div/>",{id:"socketbells","class":"bellsnwhistles",display:"none"}));d3.select("#bellsnwhistles").append("div").text("Servers").classed("bells-label",true);d3.select("#bellsnwhistles").append("div").text("Ctrl + Click to select multiple servers.").style("font-style","italic").style("text-align","center").style("padding-bottom","5px");d3.select("#processbells").append("div").text("Processes").classed("bells-label",true);d3.select("#socketbells").append("div").text("Sockets").classed("bells-label",true);d3.select("#processbells").append("div").attr("id","box-container").append("div").classed("label",true).text("Filter: ");d3.select("#box-container").append("input").attr("id","textBox").attr("type","text").attr("oninput","filterProcesses()").attr("disabled",true);$("#processbells").hide();$("#socketbells").hide();var e=["cpu","inbound traffic"];var t=d3.select("#processbells").append("div").classed("ptcombobox",true);t.append("div").classed("combolabel",true).text("Threshold: ");t.append("form").attr("name","ptcombobox").append("select").attr("name","selection").attr("size",1).attr("onChange","changeProcThreshold()");e.forEach(function(e){d3.select(".ptcombobox").select("form").select("select").append("option").attr("value",e).text(e)});var n=function(e){var t=["data sent","data received","time open"];var n=d3.select("#socketbells").append("div").classed("combobox",true).attr("id","socombobox");n.append("div").classed("combolabel",true).text("Threshold: ");n.append("form").attr("name","socombobox").append("select").attr("name","soselection").attr("size",1).attr("onchange","changeSocketThreshold()");t.forEach(function(e){d3.select("#socombobox").select("form").select("select").append("option").attr("value",e).text(e)});d3.select("#socketbells").append("div").attr("id","socket_threshold_filter");d3.select("#socket_threshold_filter").append("div").text("Heatmap Filter").style("text-align","center").style("padding-right","15px").style("font-weight","bold");d3.select("#socket_threshold_filter").append("div").classed("socket_threshold_filter slider",true);$(function(){$(".socket_threshold_filter").slider({slide:function(e,t){d3.select("#socket_filter_value").text(function(){var e=$(".socket_threshold_filter").slider("option","value");if(socombobox[1].soselection.selectedIndex==0||socombobox[1].soselection.selectedIndex==1){return viewDataSize(e)}else if(socombobox[1].soselection.selectedIndex==2){return e}})},change:function(e,t){filterSockets(t.value);d3.select("#socket_filter_value").text(function(){var e=$(".socket_threshold_filter").slider("option","value");if(socombobox[1].soselection.selectedIndex==0||socombobox[1].soselection.selectedIndex==1){return viewDataSize(e)}else if(socombobox[1].soselection.selectedIndex==2){return e}})},step:100,min:0,max:1048576,value:0});if(e!=undefined){e()}});d3.select("#socket_threshold_filter").append("div").attr("id","socket_filter_value").classed("slider-value",true).text("0 B")};var r=function(e){d3.select("#processbells").append("div").attr("id","proc_threshold_filter");d3.select("#proc_threshold_filter").append("div").text("Heatmap Filter").style("text-align","center").style("padding-right","15px").style("padding-top","5px").style("font-weight","bold");d3.select("#proc_threshold_filter").append("div").classed("proc_threshold_filter slider",true);$(function(){$(".proc_threshold_filter").slider({slide:function(e,t){d3.select("#proc_filter_value").text(function(){var e=$(".proc_threshold_filter").slider("option","value");return e})},change:function(e,t){filterProcesses(t.value);d3.select("#proc_filter_value").text(function(){var e=$(".proc_threshold_filter").slider("option","value");return e})},step:1,min:0,max:50,value:0});if(e!=undefined){e()}});d3.select("#proc_threshold_filter").append("div").attr("id","proc_filter_value").classed("slider-value",true).text("0%")};var i=function(e){d3.select("#processbells").append("div").attr("id","proc_threshold_slider");d3.select("#proc_threshold_slider").append("div").text("Heatmap Threshold").style("text-align","center").style("padding-right","15px").style("font-weight","bold");d3.select("#proc_threshold_slider").append("div").classed("proc_threshold_slider slider",true);$(function(){$(".proc_threshold_slider").slider({slide:function(e,t){adjustProcessColors(t.value);d3.select("#proc_slider_value").text(function(){var e=$(".proc_threshold_slider").slider("option","value");if(ptcombobox.selection.selectedIndex==0){return e+"%"}else if(ptcombobox.selection.selectedIndex==1){return viewDataSize(e)}})},change:function(e,t){adjustProcessColors(t.value);d3.select("#proc_slider_value").text(function(){var e=$(".proc_threshold_slider").slider("option","value");if(ptcombobox.selection.selectedIndex==0){return e+"%"}else if(ptcombobox.selection.selectedIndex==1){return viewDataSize(e)}})},step:1,min:0,max:100,value:100});if(e!=undefined){e(null,$(".threshold_slider").slider("option","value"))}});d3.select("#proc_threshold_slider").append("div").attr("id","proc_slider_value").classed("slider-value",true).text("100%");var t=["name","cpu","inbound traffic","outbound traffic","no. of responses"];var n=d3.select("#processbells").append("div").attr("id","pcombobox").classed("combobox",true);n.append("div").classed("combolabel",true).text("Sort: ");n.append("form").attr("name","pvcombobox").append("select").attr("name","selection").attr("size",1).attr("onChange","sortProcesses()");t.forEach(function(e){d3.select("#pcombobox").select("form").select("select").append("option").attr("value",e).text(e)})};var s=function(e){d3.select("#bellsnwhistles").append("div").attr("id","threshold_slider");var t=["cpu","no. of processes","inbound traffic","outbound traffic"];var n=d3.select("#threshold_slider").append("div").classed("tcombobox",true);n.append("div").classed("combolabel",true).text("Threshold: ");n.append("form").attr("name","tcombobox").append("select").attr("name","selection").attr("size",1).attr("onChange","changeThreshold()");t.forEach(function(e){d3.select(".tcombobox").select("form").select("select").append("option").attr("value",e).text(e)});d3.select("#threshold_slider").append("div").text("Heatmap Threshold").style("text-align","center").style("padding-right","15px").style("font-weight","bold");d3.select("#threshold_slider").append("div").classed("threshold_slider slider",true);$(function(){$(".threshold_slider").slider({slide:function(e,t){adjustServerColors(t.value);d3.select("#slider_value").text(function(){var e=$(".threshold_slider").slider("option","value");if(tcombobox.selection.selectedIndex==0){return e+"%"}else if(tcombobox.selection.selectedIndex==1){return e}else if(tcombobox.selection.selectedIndex==2||tcombobox.selection.selectedIndex==3){return viewDataSize(e)}})},change:function(e,t){adjustServerColors(t.value);d3.select("#slider_value").text(function(){var e=$(".threshold_slider").slider("option","value");if(tcombobox.selection.selectedIndex==0){return e+"%"}else if(tcombobox.selection.selectedIndex==1){return e}else if(tcombobox.selection.selectedIndex==2||tcombobox.selection.selectedIndex==3){return viewDataSize(e)}})},step:1,min:0,max:100,value:100});e(null,$(".threshold_slider").slider("option","value"))});d3.select("#threshold_slider").append("div").attr("id","slider_value").text("100%")};var o=function(e){var t=["name","cpu","no. of processes","inbound traffic","outbound traffic","page faults"];var n=d3.select("#bellsnwhistles").append("div").classed("combobox",true).attr("id","scombobox");n.append("div").classed("combolabel",true).text("Sort: ");n.append("form").attr("name","combobox").append("select").attr("name","selection").attr("size",1).attr("onChange","filterServers()");t.forEach(function(e){d3.select("#scombobox").select("form").select("select").append("option").attr("value",e).text(e)});d3.select("#bellsnwhistles").append("div").text("Selected Servers").style("font-weight","bold").style("text-align","center").style("padding-bottom","5px");if(e!=undefined){e()}};var u=function(e,t,n){d3.select("#"+e).append("div").classed("dirty-numbers",true).attr("id",t+"-numbers");if(n!=undefined){n()}};queue().defer(r).defer(n).defer(s).defer(o).defer(i).defer(adjustServerColors,$(".threshold_slider").slider("option","value")).defer(u,"bellsnwhistles","server").defer(u,"socketbells","socket").awaitAll(function(){d3.select("#server-numbers").append("div").style("font-weight","bold").attr("id","selected-servers");var e=d3.select("#socket-numbers").append("g").attr("id","socket-details");e.append("div").attr("id","socket-status").text("Status: ");e.append("div").attr("id","socket-type").text("Type: ");e.append("div").attr("id","socket-port").text("Port: ");e.append("div").attr("id","socket-sent").text("Data sent: ");e.append("div").attr("id","socket-received").text("Data received: ");e.append("div").attr("id","socket-linked").text("Linked to: ");e.append("div").attr("id","socket-time").text("Time Open: ")})}function showLines(e){function t(e){d3.select("#socket").append("circle").attr("cx",300).attr("cy",300).attr("r",socketRadius).style("fill","none").style("stroke-width",1).style("stroke","black").attr("opacity",0).transition().duration(1e3).attr("opacity",1);var t=typeof e.sockets!="undefined"?e.sockets.length:0;if(typeof e.sockets!="undefined"){d3.select("#socket").selectAll("line").data(e.sockets).enter().append("line").attr("x1",300).attr("y1",300).attr("x2",300).attr("y2",300).style("stroke","black").style("stroke-width",2).transition().duration(1e3).attr("x2",function(e,n){return 300+socketRadius*Math.cos(n*2*Math.PI/t-Math.PI/2)}).attr("y2",function(e,n){return 300+socketRadius*Math.sin(n*2*Math.PI/t-Math.PI/2)}).each("end",function(e,t){d3.select(this).on("mouseover",function(){mOverSocket(this)})})}}queue().defer(d3.json,"http://localhost:9000/api/processes/"+e+"/detail/").awaitAll(function(e,n){t(n[0])})}function processes(e){function n(e,n){var r=function(e,t){var n="http://localhost:9000/api/v1/metrics/?name=sys.server."+e+".process.*";d3.json(n,function(n,r){parsedData=[];if(typeof r!=="undefined"){r=r["data"][e]}for(var i in r){for(var s in r[i][0]){parsedData.push({name:r[i][0][s][1],id:s.split(",").join("_"),data:r[i][0][s]})}}t(null,parsedData)})};var i=queue();e.forEach(function(e,t){i.defer(r,collectorIDs[e])});i.awaitAll(function(e,r){var i=r[0].length>1?t(r):r[0];n(null,i)})}function r(e){var t=d3.select("#mainsvg").append("g").attr("id","procs").selectAll("g").data(e).enter().append("g").on("mouseover",function(e){mOverProcess(e,d3.select(this))}).on("mouseout",function(){mOutProcess(d3.select(this))}).on("click",function(e,t){zoomIn(this,t)}).on("mousemove",function(e,t){moveToolTip()}).append("rect").classed("hoverable",true).attr("display","none").attr("stroke","gray").attr("stroke-width",1).attr("width",40).attr("height",40).attr("x",function(e,t){return 40*(t%12)+60}).attr("y",function(e,t){return 40*Math.floor(t/12)+60});d3.select("#procs").selectAll("g").append("text").classed("quick-num",true).text(function(e){return e.data[0].cpu}).attr("x",function(e,t){return 80+40*(t%12)}).attr("y",function(e,t){return 80+40*Math.floor(t/12)}).style("display","none");$("#procs g *").fadeIn();d3.select(".backbutton").on("mousedown",function(){zoomOut()});adjustProcessColors(100)}var t=function(e){var n=[];var r;for(var i=0;i<e.length;i++){if(!Array.isArray(e[i])){n.push(e[i])}else{r=t(e[i]);for(var s=0;s<r.length;s++){n.push(r[s])}}}return n};queue(1).defer(n,e).awaitAll(function(e,t){r(t[0]);d3.select("#textBox").attr("disabled",null)})}function sortProcesses(){function n(e,t){if(e.name.toLowerCase()<t.name.toLowerCase()){return-1}else if(e.name.toLowerCase()==t.name.toLowerCase()){return 0}else{return 1}}function r(e,t){if(Number(e.data[0].sread)<Number(t.data[0].sread)){return-1}else if(Number(e.data[0].sread)==Number(t.data[0].sread)){return 0}else{return 1}}function i(e,t){if(Number(e.data[0].swrite)<Number(t.data[0].swrite)){return-1}else if(Number(e.data[0].swrite)==Number(t.data[0].swrite)){return 0}else{return 1}}function s(e,t){if(Number(e.data[0].cpu)<Number(t.data[0].cpu)){return-1}else if(Number(e.data[0].cpu)==Number(t.data[0].cpu)){return 0}else{return 1}}function o(e,t){if(Number(e.data[0].resp_num)<Number(t.data[0].resp_num)){return-1}else if(Number(e.data[0].resp_num)==Number(t.data[0].resp_num)){return 0}else{return 1}}var e=d3.select("#procs").selectAll("g");if(pvcombobox.selection.selectedIndex==0){var t=e.sort(n)}else if(pvcombobox.selection.selectedIndex==1){var t=e.sort(s)}else if(pvcombobox.selection.selectedIndex==2){var t=e.sort(r)}else if(pvcombobox.selection.selectedIndex==3){var t=e.sort(i)}else if(pvcombobox.selection.selectedIndex==4){var t=e.sort(o)}t[0].forEach(function(e,t){d3.select(e).transition().duration(1e3).attr("transform",function(n){var r=-d3.select(e).select("rect").attr("x")+60+t%12*40;var i=-d3.select(e).select("rect").attr("y")+60+40*Math.floor(t/12);return"translate("+r+","+i+")"})});filterProcesses()}function filterProcesses(e){var t=d3.select("#textBox")[0][0].value;var n=[];var r=d3.select("#procs").selectAll("g")[0];var i=typeof e=="undefined"?$(".proc_threshold_filter").slider("option","value"):e;d3.select("#procs").selectAll("g")[0].forEach(function(e,t){d3.select(e).attr("display","inline")});d3.select("#procs").selectAll("rect")[0].forEach(function(e,r){if(ptcombobox.selection.selectedIndex==0&&e.__data__.data[0].cpu<i||ptcombobox.selection.selectedIndex==1&&e.__data__.data[0].sread<i||e.__data__.name.indexOf(t.toLowerCase())==-1){n.push(false)}else{n.push(true)}});var s=0;n.forEach(function(e,t){if(n[t]){d3.select(r[t]).transition().duration(1e3).attr("transform",function(e){var n=-d3.select(r[t]).select("rect").attr("x")+60+s%12*40;var i=-d3.select(r[t]).select("rect").attr("y")+60+40*Math.floor(s/12);return"translate("+n+","+i+")"}).attr("opacity",1).moveToFront;s=s+1}else{d3.select(r[t]).transition().attr("opacity",0)}});d3.select("#procs").selectAll("g")[0].forEach(function(e,t){if(!n[t]){d3.select(e).attr("display","none")}})}var rgcolor=d3.scale.linear().domain([1,2,3,4,5,6,7,8,9,10]).range(["#00FF00","#40FF00","#80FF00","#BFFF00","#FFFF00","#FFBF00","#FF8000","#FF5C26","#FF4000","#FF0000"]);var mainDiv=d3.select("body").append("div").attr("id","mainDiv");var columns=15;var rows=10;var buckets=11;var layer=1;var servers={};var collectorIDs={};var serverLinkMap=[];var transition=false;var socketRadius=250;var ctrlPressed=false;var buttonDown=false;var multiServer=false;d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var getFile=function(e,t){$.ajax({url:e,dataType:"json",crossDomain:true,jsonp:"callback",success:function(e){t(null,e)},error:function(e,n){t(n,null)}})};$.ajax({url:"http://localhost:9000/api/topology/",dataType:"json",crossDomain:true,jsonp:"callback",success:function(e){serverLinkMap=[];e.Node.forEach(function(e){if(typeof e.ips!="undefined"){JSON.parse(e.ips).forEach(function(t){serverLinkMap[t]=e.id})}});serverLinkMap["127.0.0.1"]="self"},error:function(e,t){console.log(t)}});var adjustServerColors=function(e,t){var n=d3.scale.quantile().domain([0,e]).range(d3.range(10));if(!transition){d3.select("body").select("#mainDiv").select("svg").select("g").selectAll("rect").style("fill",function(e){if(tcombobox.selection.selectedIndex==0){return rgcolor(1+n(servers[e].cpu))}else if(tcombobox.selection.selectedIndex==1){return rgcolor(1+n(servers[e].pnum))}else if(tcombobox.selection.selectedIndex==2){return rgcolor(1+n(servers[e].sread))}else if(tcombobox.selection.selectedIndex==3){return rgcolor(1+n(servers[e].swrite))}}).attr("class",function(e){return"hoverable"})}if(transition){d3.select("body").select("#mainDiv").select("svg").select("g").selectAll("rect").transition().duration(1e3).style("fill",function(e){if(tcombobox.selection.selectedIndex==0){return rgcolor(1+n(servers[e].cpu))}else if(tcombobox.selection.selectedIndex==1){return rgcolor(1+n(servers[e].pnum))}else if(tcombobox.selection.selectedIndex==2){return rgcolor(1+n(servers[e].sread))}else if(tcombobox.selection.selectedIndex==3){return rgcolor(1+n(servers[e].swrite))}}).attr("class",function(e){return"hoverable"})}if(typeof t!="undefined"){t()}};var adjustProcessColors=function(e,t){var n=d3.scale.quantile().domain([0,e]).range(d3.range(10));if(!transition){d3.select("#procs").selectAll("rect").style("fill",function(e){if(ptcombobox.selection.selectedIndex==0){return rgcolor(1+n(e.data[0].cpu))}else if(ptcombobox.selection.selectedIndex==1){return rgcolor(1+n(e.data[0].sread))}}).attr("class",function(e){return"hoverable"})}if(transition){d3.select("#procs").selectAll("rect").transition().duration(1e3).style("fill",function(e){if(ptcombobox.selection.selectedIndex==0){return rgcolor(1+n(e.data[0].cpu))}else if(ptcombobox.selection.selectedIndex==1){return rgcolor(1+n(e.data[0].sread))}}).attr("class",function(e){return"hoverable"})}if(typeof t!="undefined"){t()}};var adjustSocketColors=function(e,t){var n=d3.scale.quantile().domain([0,e]).range(d3.range(10))};var loadedMore=function(e,t){d3.select("#loading").transition().duration(1e3).ease("linear").attr("width",140*(e/100)).each("end",function(){if(e==100){d3.select("#loading").remove();d3.select("#loading-bar").remove()}if(t!=undefined){t()}})};main()